<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ATS_RP3B_v1.0 - Strategy Analysis</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #3498db;
            text-decoration: none;
            font-weight: 500;
        }
        .back-link:hover {
            text-decoration: underline;
        }
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        h2 {
            color: #34495e;
            margin-top: 30px;
            border-left: 4px solid #3498db;
            padding-left: 15px;
        }
        .header-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .info-box {
            background-color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #3498db;
        }
        .info-box strong {
            color: #2c3e50;
            display: block;
            margin-bottom: 5px;
        }
        .score {
            font-size: 24px;
            font-weight: bold;
            color: #27ae60;
        }
        .score.low {
            color: #e74c3c;
        }
        .score.medium {
            color: #f39c12;
        }
        .section {
            margin: 25px 0;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .code-block {
            background-color: #282c34;
            color: #abb2bf;
            padding: 20px;
            border-radius: 5px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
        }
        .badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            background-color: #3498db;
            color: white;
            font-size: 14px;
            margin-right: 10px;
        }
        .badge.yes {
            background-color: #27ae60;
        }
        .badge.no {
            background-color: #95a5a6;
        }
        ul {
            list-style-type: none;
            padding-left: 0;
        }
        ul li {
            padding: 8px;
            margin: 5px 0;
            background-color: #e8f4f8;
            border-left: 3px solid #3498db;
            padding-left: 15px;
        }
        .quality-analysis {
            background-color: #fff9e6;
            border: 1px solid #f1c40f;
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
        }
    </style>
    <style>
        /* KPI Dashboard Styles */
        .kpi-dashboard {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            padding: 25px;
            margin: 25px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .kpi-dashboard h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            border-left: 4px solid #3498db;
            padding-left: 15px;
        }
        
        .kpi-dashboard h3 {
            color: #34495e;
            margin: 20px 0 15px 0;
            font-size: 1.1em;
        }
        
        .kpi-header-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .kpi-chip {
            background: white;
            border-radius: 20px;
            padding: 8px 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .chip-label {
            color: #7f8c8d;
            font-size: 0.85em;
        }
        
        .chip-value {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .kpi-main-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .kpi-secondary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .kpi-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }
        
        .kpi-card.main {
            padding: 20px;
        }
        
        .kpi-card.main .kpi-value {
            font-size: 1.8em;
        }
        
        .kpi-title {
            color: #7f8c8d;
            font-size: 0.85em;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .kpi-value {
            font-size: 1.4em;
            font-weight: 700;
            color: #2c3e50;
        }
        
        .kpi-value.positive {
            color: #27ae60;
        }
        
        .kpi-value.negative {
            color: #e74c3c;
        }
        
        .kpi-value.neutral {
            color: #7f8c8d;
        }
        
        .kpi-subtitle {
            font-size: 0.8em;
            color: #95a5a6;
            margin-top: 5px;
        }
        
        /* IS/OOS Section */
        .isoos-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .isoos-info {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .isoos-badge {
            padding: 12px 20px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .isoos-badge.is {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
        }
        
        .isoos-badge.oos {
            background: linear-gradient(135deg, #27ae60 0%, #219a52 100%);
            color: white;
        }
        
        .badge-label {
            font-size: 0.8em;
            opacity: 0.9;
        }
        
        .badge-value {
            font-weight: 600;
        }
        
        .badge-duration {
            font-size: 0.85em;
            opacity: 0.9;
        }
        
        .isoos-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
        }
        
        /* Period Table */
        .period-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            overflow-x: auto;
        }
        
        .period-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95em;
        }
        
        .period-table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #2c3e50;
            border-bottom: 2px solid #e9ecef;
        }
        
        .period-table td {
            padding: 12px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .period-table tr:hover {
            background: #f8f9fa;
        }
        
        .period-table .positive {
            color: #27ae60;
            font-weight: 500;
        }
        
        .period-table .negative {
            color: #e74c3c;
            font-weight: 500;
        }
        
        /* Equity Curve Section */
        .equity-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin: 25px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .equity-section h2 {
            color: #2c3e50;
            margin-bottom: 15px;
            border-left: 4px solid #27ae60;
            padding-left: 15px;
        }
        
        .equity-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
        }
        
        .legend-item .legend-color {
            width: 20px;
            height: 4px;
            border-radius: 2px;
        }
        
        .legend-item.is .legend-color {
            background: #3498db;
        }
        
        .legend-item.oos .legend-color {
            background: #27ae60;
        }
        
        .legend-item.separator {
            color: #e74c3c;
            font-weight: 500;
        }
        
        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
        }
        
        .equity-source {
            margin-top: 10px;
            text-align: right;
            color: #95a5a6;
        }
        
        .no-data {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            color: #856404;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .kpi-main-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .kpi-secondary-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .chart-container {
                height: 300px;
            }
        }
    </style>
    
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-link">‚Üê Back to Strategy List</a>
        
        <h1>üìä ATS_RP3B_v1.0</h1>
        
        <div class="header-info">
            <div class="info-box">
                <strong>Strategy Type</strong>
                <span class="badge">Error</span>
            </div>
            <div class="info-box">
                <strong>Subtype</strong>
                <span class="badge">Analysis Failed</span>
            </div>
            <div class="info-box">
                <strong>Complexity Score</strong>
                <span class="score ">N/A/10</span>
            </div>
            <div class="info-box">
                <strong>Quality Score</strong>
                <span class="score ">N/A/10</span>
            </div>
        </div>

        
            <div class="kpi-dashboard">
                <h2>üìà Performance Dashboard</h2>
                <div class="no-data">
                    <p>‚ö†Ô∏è N/A - No performance data available for this strategy in Portfolio Report.</p>
                </div>
            </div>
            

            <div class="equity-section">
                <h2>üìà Equity Curve</h2>
                <div class="no-data">
                    <p>‚ö†Ô∏è N/A - Equity curve data not available (no matching DataSource file).</p>
                </div>
            </div>
            
        <div class="section">
            <h2>üìù Summary</h2>
            <p>Analysis failed: API error: Error code: 401 - {'type': 'error', 'error': {'type': 'authentication_error', 'message': 'invalid x-api-key'}, 'request_id': 'req_011CVUr4AM8tzd5JbEfSDmLL'}</p>
        </div>

        <div class="section">
            <h2>üéØ Entry Conditions</h2>
            <p>N/A</p>
        </div>

        <div class="section">
            <h2>üö™ Exit Conditions</h2>
            <p>N/A</p>
        </div>

        <div class="header-info">
            <div class="info-box">
                <strong>Stop Loss</strong>
                <p>N/A</p>
            </div>
            <div class="info-box">
                <strong>Take Profit</strong>
                <p>N/A</p>
            </div>
            <div class="info-box">
                <strong>Exit On Close</strong>
                <span class="badge no">N/A</span>
            </div>
            <div class="info-box">
                <strong>Time Exit Condition</strong>
                <span class="badge no">N/A</span>
            </div>
        </div>

        <div class="section">
            <strong>Time Exit Details:</strong>
            <p>N/A</p>
        </div>

        <div class="section">
            <h2>üîß Function Patterns Used</h2>
            <ul>
                <li>No patterns identified</li>
            </ul>
            <p><strong>Number of patterns:</strong> N/A</p>
        </div>

        <div class="quality-analysis">
            <h2>‚≠ê Quality Analysis</h2>
            <p>API error: Error code: 401 - {'type': 'error', 'error': {'type': 'authentication_error', 'message': 'invalid x-api-key'}, 'request_id': 'req_011CVUr4AM8tzd5JbEfSDmLL'}</p>
        </div>

        <h2>üíª Strategy Code</h2>
        <div class="code-block">
            <pre>{ ALGORITHME RP3B SIMPLIFIE 

PASSE 15 A 30 TRADES PAR AN SUR DAX FUTURE (FDXM TESTE) AVEC BONS RESULTATS (CF BACKTESTS)

Condition Entree:
Si on est en P2B depuis plus de 3 barres ET on est sous M7 descendante (high&lt;m7) 
    ET que le SAR a croise depuis 2 periodes max OU va croiser dans 2 periodes max (projection) la M20 a la baisse 
    ET que le plus bas de la P2B a ete atteint (low&gt;=lowestP2B) 
    ET qu&#39;on est sur un Support Fort d&#39;unite superieure (ici on retient comme &quot;strong support&quot; : Plus bas de la veille OU Plus bas des 5 derniers jours OU plus bas des 30 derniers jours
ALORS 
	Acheter 3 contrats at Market

TP1: SMA7
TP2: SMA20 ou SAR si plus petit (mais au dessus du prix)
TP3: TrailingStop
SL: X PiP
}

//&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;	Michael OHLC Calculation begin
array: ohlcValues[23](0);

var: isStartOfSession(false);

//&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;	Michael OHLC Calculation end
input: sessionStartTimeA(0100), sessionEndTimeA(2200);

isStartOfSession = _OHLCMulti5(sessionStartTimeA, sessionStartTimeA, ohlcValues);

Inputs: EpsilonSupport (10), param_SLLong1 (100), param_SLLong2 (20), param_TrailingSL (20), use_sar_filter (1), use_DayUpTrend (1), use_volatilityfilter(0), ATR_Factor_BorneSup (0.9), ATR_Factor_Borne_Inf(0.5), use_DaySupport(1), use_WeekSupports(1), ptnNeutLongYes (55), PtnNeutLongNo(56), PtnLongDirYes(52), PtnLongDirNo(53),
	exitOnClose (0), ProfitProtector(0), NoTradeDay(0), NoTradeMonth(0), exitOnFriday(0),
   	Trading_StartTime(0100), TradingEndTime(2200), pause_start(0000), pause_end(0000), use_rsi_filter (0), len_rsi (14), limit_rsi (30), use_rsi_div_filter (0), use_volume_filter(0), volume_len(10), use_cci_filter(0), cci_borneInf (20);

Vars: sma7 (0), sma20(0), sar (0), bbMiddle(0), bbh(0), bbl(0), bbStdDev(0), sma7_decroissante (false), sma20_decroissante (false), p2b (false), sar_crossedunder_m20 (false), debut_p3b (false),
  pente_projetee_SAR (1), pente_projetee_sma20 (1), Daily_SMA20 (0), Daily_SMA20_croissante (false), DayUpTrend (false),
  isOnStrongSupport (false),
  SAR_projete_1bar (0), SAR_projete_2bar (0), SAR_projete_3bar (0), SMA20_projete_1bar (0), SMA20_projete_2bar (0), SMA20_projete_3bar (0), LowestSinceP2B(999999), P2BConditionMet(false), rp3b_signal (false), 
  objective1 (0), objective2 (0), current_objective (0), sar_filter (true), volatility_filter (true),
  activateProfitProtector(false), tw (false), pause_window(false), canTrade(false),
  macd_filter (0), volume_filter (false), rsi_highestHigh(0), div_rsi(false), cci_filter(false);



// Momentum indicators

// TEST DU FILTRE SUR LES VOLUMES
volume_filter = volume &gt; average(volume, volume_len)*1.1; // +StdDev(volume, 10)*1;
if use_volume_filter=0 then volume_filter=true;


// TEST DU FILTRE SUR STOCHASTIQUE
cci_filter = CCIClassic(14)&gt; average(cciclassic(14),9) and CCIClassic(15)[1]&lt; average(cciclassic(14),9);
if use_cci_filter=0 then cci_filter=true;


// TEST DU FILTRE RSI
vars: rsi (0), len(14), rsi_filter (true);
rsi = RSIClassic(close,len_rsi);
rsi_filter = rsi&gt;30 and rsi[1]&lt;limit_rsi;
if use_rsi_filter=0 then rsi_filter = true;

rsi_highestHigh = highest(rsi,len_rsi);
div_rsi = rsi_highestHigh[1]&lt;=rsi;
if use_rsi_div_filter=0 then div_rsi=true;


{CALCUL DES INDICATEURS PRINCIPAUX - FACTORIS?}
sma7 = Average(Close, 7);
sma20 = Average(Close, 20);
sar = ATS_ParabolicSAR_TF(0.02, 0.02, 0.2) ;

{Calcul des Bandes de Bollinger factorisE}
{bbStdDev = StandardDev(Close, 20, 1);
bbh = sma20 + 2 * bbStdDev;
bbl = sma20 - 2 * bbStdDev;  }


bbStdDev = StandardDev(Close, 20, 1);
bbh = BollingerBand(close, 20,  2.0);
bbl = BollingerBand(close, 20, -2.0);


sma7_decroissante = sma7&lt;sma7[1];
sma20_decroissante = sma20&lt;sma20[1];


p2b = bbh&gt;bbh[1] and bbl&lt;bbl[1] and bbh[1]&gt;bbh[2] and bbl[1]&lt;bbl[2] and sma7_decroissante ;
debut_p3b = p2b[1] and bbh&lt;bbh[1] and bbl&lt;bbl[1];

sar_crossedunder_m20 = sar[1]&gt;sma20 and sar&lt;sma20;
pente_projetee_SAR = IFF(sar[1]&gt;0, sar/sar[1], 0);
pente_projetee_sma20 = IFF(sma20[1]&gt;0, sma20/sma20[1], 0);

SAR_projete_1bar = sar * pente_projetee_SAR;
SAR_projete_2bar = sar * square(pente_projetee_SAR);
SAR_projete_3bar = sar * square(pente_projetee_SAR)*pente_projetee_SAR;
SMA20_projete_1bar = sma20 * pente_projetee_SAR;
SMA20_projete_2bar = sma20 * square(pente_projetee_sma20);
SMA20_projete_3bar = sma20 * square(pente_projetee_sma20)*pente_projetee_sma20;

Daily_SMA20 = average(close of data2, 20);
Daily_SMA20_croissante = average(close of data2, 200) &gt; average(close[1] of data2, 200) and close &gt;  average(close[1] of data2, 200);

if use_DayUpTrend = 1 then DayUptrend=Daily_SMA20_croissante and close&gt;Daily_SMA20
else DayUpTrend=true;

if use_volatilityfilter=1 then volatility_filter = TrueRange &lt;= Average(truerange,5)*ATR_Factor_BorneSup and truerange&gt;=average(truerange,5)*ATR_Factor_Borne_Inf
Else volatility_filter = true ;

rp3b_signal=false;
// LowestSinceP2B=99999999;

// R?initialise quand la condition devient vraie
if p2b and p2b[1]=false then begin
    LowestSinceP2B = MinList(low, low[1]);
    P2BConditionMet = true;
end
// Met ? jour le minimum tant que la condition reste vraie ou apr?s qu&#39;elle ait ?t? vraie
else if P2BConditionMet then begin
    if p2b then
        LowestSinceP2B = MinList(LowestSinceP2B, low)
    else
        //LowestSinceP2B = 9999999 ; 
        LowestSinceP2B = MinList(LowestSinceP2B, close);
end;

isOnStrongSupport = (low - EpsilonSupport&lt;= LowD(1) and low &gt; lowD(1) )  or (low - EpsilonSupport &lt;= LowD(5) and low &gt; lowD(5)) or (low- EpsilonSupport &lt;= LowD(30) and low &gt; lowD(30)) ;
if use_DaySupport=1 then isOnStrongSupport = isOnStrongSupport or (low - EpsilonSupport&lt;= average(close of data2, 20)and low &gt; average(close of data2, 20) ) or (low - EpsilonSupport&lt;= average(close of data2, 50)and low &gt; average(close of data2, 50))
  or (low - EpsilonSupport&lt;= average(close of data2, 100)and low &gt; average(close of data2, 100)) or (low - EpsilonSupport&lt;= average(close of data2, 200)and low &gt; average(close of data2, 200));
// Ajout des SAR Daily:
//  or (low - EpsilonSupport&lt;= ATS_ParabolicSAR_TF(0.02, 0.02, 0.2) of data2 and low &gt;= ATS_ParabolicSAR_TF(0.02, 0.02, 0.2) and ATS_ParabolicSAR_TF(0.02, 0.02, 0.2) &lt; close of data2);
// Ajout des BBL Daily:
//   or  (low - EpsilonSupport&lt;=StandardDev(Close of data2, 20, 1)*-2 + Daily_SMA20 and low &gt; StandardDev(Close of data2, 20, 1)*-2) ;

if use_WeekSupports=1 Then isOnStrongSupport = isOnStrongSupport or (low - EpsilonSupport&lt;= average(close of data3, 20)and low &gt; average(close of data3, 20)) or (low - EpsilonSupport&lt;= average(close of data3, 50)and low &gt; average(close of data3, 50));

if use_sar_filter=1 then sar_filter = 
  ( (sar_crossedunder_m20 or sar_crossedunder_m20[1] or sar_crossedunder_m20[2] ) 
  or (SAR_projete_1bar &lt; SMA20_projete_1bar and sar &gt; sma20)
  or (SAR_projete_2bar &lt; SMA20_projete_2bar and SAR_projete_1bar &gt; SMA20_projete_1bar) )
else sar_filter=true;


if ( 
  (p2b and p2b[1] and p2b[2]) // or debut_p3b // or (UTBollPhase[1]=&quot;P3B&quot; and UTBollPhase[1][1]=&quot;P2B&quot;) )
  and (high&lt; sma7 ) // or (high&lt;UTData[1,IDX_M7] and high&gt;UTData[1,IDX_BBL] and close[1]&lt;UTData[1, IDX_BBL]) )
  and sar_filter
  // or (SAR_projete_3bar &lt; SMA20_projete_3bar and SAR_projete_2bar &gt; SMA20_projete_2bar) )
  and low&gt;= LowestSinceP2B )
  // and close-low &gt; high-close
  // and close&gt; Daily_SMA20 
  and DayUpTrend //Daily_SMA20_croissante
  and volatility_filter
  and isOnStrongSupport 
  // and close&gt;open 
  and PatternDirectionalFast(PtnLongDirYes, ohlcValues) and PatternDirectionalFast(PtnLongDirNo, ohlcValues)=false
  and PatternNeutralFast(PtnNeutLongYes, ohlcValues) and PatternNeutralFast(PtnNeutLongNo, ohlcValues) = false
  and volume_filter
  and rsi_filter 
  and div_rsi
  and cci_filter
  then
  // Fait passe le WinRate a 100% avec avg trade de 145Eur sur FDXM mais trades rares: and close &gt; open
	rp3b_signal = true
  else rp3b_signal = false;

inputs: use_m7_objective1 (1);

if use_m7_objective1 =1 then begin
	objective1 = sma7;
	if sar[1]&lt;low[1] then
	  objective2 = sma20 
	else objective2 = minlist(sma20, sar);
end
else 
  if sar[1]&lt;low[1] then begin
	objective1 = sma20 ;
	objective2 = objective1;
  end
  else begin
    objective1 = minlist(sma20, sar);
    objective2 = maxlist(sma20, sar);
  end;


tw = (time &gt;= Trading_StartTime and time &lt; TradingEndTime);
pause_window= (time &gt;= pause_start and time &lt; pause_end );

canTrade = tw and pause_window=false and dayofweek(date) &lt;&gt; NoTradeDay ;


Inputs: myContracts (3), BE_after_TP1 (0);
vars: nbContracts (0);
nbContracts = myContracts;


if canTrade and marketposition=0 and rp3b_signal Then //and TradingWindow //and UTBollPhase[1]=&quot;P2B&quot;
  // and (Time&lt;session_PauseStart1 or Time&gt;session_PauseEnd1) 
  // and (Time&lt;session_PauseStart2 or Time&gt;session_PauseEnd2)  Then // and TradingWindow and dayofweek(date) &lt;&gt; 5 Then
	Begin
		buy (&quot;RP3B&quot;) myContracts Contracts next bar at market;
		current_objective= objective1;
	End; 

setstoploss_pt(param_SLLong1);//-param_ClusterPips);

// Gestion des TP Partiels et SL:

// Si on est en position avec 2 contrats alors on met le TP1  Objectif 1 et on monte le SL a BE
if MarketPosition = 1 and currentcontracts=3 Then // and globalTradingEnabled then
	Begin
	    Sell(&quot;TP1_30pct&quot;) 1 contracts next bar at current_objective limit;
	    //setstoploss_pt(param_SLLong);
	End;
if MarketPosition = 1 and currentcontracts=2 then // and globalTradingEnabled then
	Begin
	    current_objective=objective2;
	    Sell(&quot;TP1_50pct&quot;) 1 contracts next bar at current_objective limit;
	    if BE_after_TP1 = 1 then
	    	setstoploss(absvalue(close-entryprice))
	    else setstoploss_pt(param_SLLong2);
	End;

if MarketPosition = 1 and currentcontracts=1 then  //and globalTradingEnabled then
	Begin
	    settrailingstop_pt(param_TrailingSL) ; //Sell(&quot;TP1_50pct&quot;) 1 contracts next bar at current_objective limit;
	    //setstoploss_pt(param_SLLong);
	End;

// EXIT CONDITION EVALUATION

//	exitOnClose (0), ProfitProtector(0), PiP_ProtectionTarget(100), NoTradeDay(0), NoTradeMonth(0), exitOnFriday(0);

if exitOnClose=1 and marketposition = 1 then setexitonclose;

//set ppfloor and ppratio to protect profit
Inputs:
    ppfloor_pip(100),    // Seuil de profit minimum avant d&#39;activer la sortie
    ppratio(0.80);    // Ratio de profit ? conserver (ex: 60%)

if ProfitProtector = 1 and MaxPositionProfit/bigpointvalue &gt;= ppfloor_pip  then //and globalTradingEnabled then
begin
    // Si le profit latent est retomb? sous 60% du profit maximum atteint, on sort
    if (OpenPositionProfit / MaxPositionProfit) &lt; ppratio then
    begin
        Sell next bar at market;
        BuyToCover next bar at market;
    end;
end;

if marketposition=1 and dayofweek(date) = 5 and exitOnFriday=1 then
	setexitonclose;
</pre>
        </div>
    </div>
</body>
</html>
